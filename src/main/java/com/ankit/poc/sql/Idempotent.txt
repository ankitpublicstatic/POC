Idempotent APIs are a core concept in reliable, distributed systemsâ€”especially for payments, banking, order processing, and retries.

Iâ€™ll explain this clearly + deeply, with real-world examples, HTTP semantics, and Spring Boot implementation.

---

 1ï¸âƒ£ What Is an Idempotent API?

> An API is idempotent if calling it multiple times with the same request produces the same result as calling it once.

 Simple definition

```
1 call  â†’ effect
10 calls â†’ same effect (not repeated)
```

---

 2ï¸âƒ£ Why Idempotency Is Needed (Real World)

In real systems:

 Network timeouts happen
 Clients retry requests
 Load balancers retry
 Mobile apps resend requests

Without idempotency â†’ duplicate actions:

 Double debit
 Duplicate orders
 Duplicate emails

---

 3ï¸âƒ£ Idempotency vs Duplicate Requests

âŒ Non-idempotent:

```
POST /debit 100
POST /debit 100   â†’ balance deducted twice
```

âœ… Idempotent:

```
POST /debit 100 (same request-id)
POST /debit 100 â†’ second call ignored / returns same result
```

---

 4ï¸âƒ£ HTTP Methods & Idempotency

| HTTP Method | Idempotent     | Explanation          |
| ----------- | -------------- | -------------------- |
| GET         | âœ…              | No state change      |
| PUT         | âœ…              | Replace resource     |
| DELETE      | âœ…              | Delete once          |
| POST        | âŒ (by default) | Creates new resource |
| PATCH       | âŒ              | Partial update       |

âš ï¸ POST can be made idempotent by design.

---

 5ï¸âƒ£ Example: Non-Idempotent Debit API (âŒ)

```http
POST /accounts/123/debit
{
  "amount": 100
}
```

If client retries â†’ money deducted again

---

 6ï¸âƒ£ Making a Debit API Idempotent (âœ…)

 Key Idea

 Client sends Idempotency Key
 Server processes request once
 Same key â†’ same response

---

 6.1 API Request

```http
POST /accounts/123/debit
Idempotency-Key: 8f7e-abc-999

{
  "amount": 100
}
```

---

 6.2 Database Table

```sql
CREATE TABLE idempotency_keys (
  key VARCHAR(64) PRIMARY KEY,
  request_hash VARCHAR(64),
  response JSON,
  status VARCHAR(20),
  created_at TIMESTAMP
);
```

---

 6.3 Spring Boot Filter / Interceptor

```java
@Component
public class IdempotencyFilter implements Filter {

    @Autowired
    IdempotencyRepository repo;

    @Override
    public void doFilter(...) {

        String key = request.getHeader("Idempotency-Key");

        if (repo.existsById(key)) {
            IdempotencyRecord record = repo.findById(key).get();
            response.getWriter().write(record.getResponse());
            return;
        }

        chain.doFilter(request, response);
    }
}
```

---

 6.4 Service Layer Logic

```java
@Transactional
public DebitResponse debit(...) {
    // 1ï¸âƒ£ Save idempotency key
    repo.save(new IdempotencyKey(key, IN_PROGRESS));

    // 2ï¸âƒ£ Perform debit
    accountService.debit(...);

    // 3ï¸âƒ£ Save response
    repo.update(key, SUCCESS, response);
}
```

---

 7ï¸âƒ£ Step-by-Step Flow (Idempotent Debit)

| Step | What Happens                         |
| ---- | ------------------------------------ |
| 1    | Client sends debit + idempotency key |
| 2    | Server checks key                    |
| 3    | Not found â†’ process debit            |
| 4    | Save response                        |
| 5    | Retry with same key                  |
| 6    | Server returns saved response        |
| 7    | No second debit                      |

---

 8ï¸âƒ£ Idempotency vs Transactions

| Feature | Transaction     | Idempotency        |
| ------- | --------------- | ------------------ |
| Scope   | DB operations   | API calls          |
| Solves  | Partial failure | Duplicate requests |
| Layer   | Database        | API layer          |

âœ” You usually need both

---

 9ï¸âƒ£ Real-World Systems Using Idempotency

 Stripe payments
 Razorpay
 PayPal
 UPI
 Order creation APIs

---

 ğŸ”¥ Interview-Ready One-Liner

> â€œIdempotent APIs ensure that multiple identical requests produce the same effect as a single request, preventing duplicate side effects in distributed systems, especially during retries and network failures.â€

---

 10ï¸âƒ£ Best Practices

âœ” Use UUID idempotency keys
âœ” Store request hash (prevent misuse)
âœ” Set TTL (cleanup old keys)
âœ” Return same HTTP response
âœ” Combine with transactions

---

If you want next:
âœ” Complete Spring Boot idempotency implementation
âœ” Redis-based idempotency (high scale)
âœ” Difference: Idempotency vs Deduplication
âœ” Saga + idempotency in microservices
 
