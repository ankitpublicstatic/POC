Two Types of Saga Patterns
1ï¸âƒ£ Choreography Saga (Event-driven) âœ… Saga using Events (Event-based Saga) âœ… (Preferred)
Characteristics:-
No central coordinator
Each service reacts to events

Loose coupling
Choreography-based
Services react to facts

Example:-   OrderPlaced â†’ PaymentService listens
			PaymentCompleted â†’ Inventory listens

2ï¸âƒ£ Orchestration Saga (Command-driven) Saga using Messages (Command-based Saga)
Characteristics:-
Direct commands
Tighter coupling
Orchestrator usually present
Central saga orchestrator
Sends commands

Example:- OrderService â†’ PaymentService
              "ChargePayment"



Saga is typically implemented using event-driven choreography, where services publish domain events after local transactions. Message-based orchestration is also possible but leads to tighter coupling and reduced scalability.

Best practice:

Hybrid model â€” Commands internally, Events externally

Message vs Event in Saga (Final Verdict)
| Use           | Use This          |
| ------------- | ----------------- |
| Start Saga    | Command / Message |
| Progress Saga | Events            |
| Notify Others | Events            |
| Compensations | Commands          |

| Aspect        | Message-based | Event-based  |
| ------------- | ------------- | ------------ |
| Coupling      | High          | Low          |
| Scalability   | Medium        | High         |
| Extensibility | Hard          | Easy         |
| Style         | Orchestration | Choreography |
| Preferred     | âŒ             | âœ…            |


Step-by-step flow

1. OrderService â†’ OrderCreated EVENT
2. PaymentService â†’ PaymentCompleted EVENT
3. InventoryService â†’ InventoryReserved EVENT
4. ShippingService â†’ ShipmentCreated EVENT

Failure scenario

Inventory fails â†’ InventoryFailed EVENT
â†’ PaymentService â†’ RefundPayment
â†’ OrderService â†’ OrderCancelled


Kafka Topics (Example)
| Topic            | Event                              |
| ---------------- | ---------------------------------- |
| order-events     | OrderCreated, OrderCancelled       |
| payment-events   | PaymentCompleted, PaymentFailed    |
| inventory-events | InventoryReserved, InventoryFailed |

This is a **very important architecture question**, and youâ€™re asking it at the **right depth** ğŸ‘
Letâ€™s go **system-design level â†’ theory â†’ event vs message â†’ real Java (Spring Boot) code â†’ failure handling â†’ interview answers**.

---

# 1ï¸âƒ£ What is Saga Design Pattern (Recap)

> **Saga** is a pattern to manage **distributed transactions** across **multiple microservices** **without 2PC**, using **local transactions + compensation**.

Each step:

* Commits locally
* Publishes something
* Next service reacts
* On failure â†’ compensating actions run

---

# 2ï¸âƒ£ Core Question: Saga is Event-based or Message-based?

ğŸ‘‰ **Answer:**

> **Saga is BOTH â€” but the best practice is EVENT-DRIVEN**

Letâ€™s clarify clearly.

---

## 2.1 Saga using Messages (Command-based Saga)

### Characteristics

* Direct commands
* Tighter coupling
* Orchestrator usually present

### Example

```
OrderService â†’ PaymentService
              "ChargePayment"
```

ğŸ“Œ This is **message-based (command)**

---

## 2.2 Saga using Events (Event-based Saga) âœ… (Preferred)

### Characteristics

* Loose coupling
* Choreography-based
* Services react to facts

### Example

```
OrderPlaced â†’ PaymentService listens
PaymentCompleted â†’ Inventory listens
```

ğŸ“Œ This is **event-driven Saga**

---

## 2.3 Quick Comparison

| Aspect        | Message-based | Event-based  |
| ------------- | ------------- | ------------ |
| Coupling      | High          | Low          |
| Scalability   | Medium        | High         |
| Extensibility | Hard          | Easy         |
| Style         | Orchestration | Choreography |
| Preferred     | âŒ             | âœ…            |

---

# 3ï¸âƒ£ Two Types of Saga Patterns

## 1ï¸âƒ£ Choreography Saga (Event-driven) âœ…

* No central coordinator
* Each service reacts to events

## 2ï¸âƒ£ Orchestration Saga (Command-driven)

* Central saga orchestrator
* Sends commands

---

# 4ï¸âƒ£ Real-world Example (E-commerce Order)

### Services

* Order Service
* Payment Service
* Inventory Service
* Shipping Service

---

# 5ï¸âƒ£ Choreography Saga (EVENT-DRIVEN) â€” Deep Dive

---

## Step-by-step flow

```
1. OrderService â†’ OrderCreated EVENT
2. PaymentService â†’ PaymentCompleted EVENT
3. InventoryService â†’ InventoryReserved EVENT
4. ShippingService â†’ ShipmentCreated EVENT
```

### Failure scenario

```
Inventory fails â†’ InventoryFailed EVENT
â†’ PaymentService â†’ RefundPayment
â†’ OrderService â†’ OrderCancelled
```

---

# 6ï¸âƒ£ Kafka Topics (Example)

| Topic            | Event                              |
| ---------------- | ---------------------------------- |
| order-events     | OrderCreated, OrderCancelled       |
| payment-events   | PaymentCompleted, PaymentFailed    |
| inventory-events | InventoryReserved, InventoryFailed |

---

# 7ï¸âƒ£ REAL Java Code (Spring Boot + Kafka)

---

## 7.1 OrderCreated Event

```java
@Data
@AllArgsConstructor
@NoArgsConstructor
public class OrderCreatedEvent {
    private String orderId;
    private BigDecimal amount;
}
```

---

## 7.2 Order Service â€“ Publish Event

```java
@Service
public class OrderService {

    private final KafkaTemplate<String, Object> kafkaTemplate;

    public OrderService(KafkaTemplate<String, Object> kafkaTemplate) {
        this.kafkaTemplate = kafkaTemplate;
    }

    public void createOrder(String orderId, BigDecimal amount) {
        // 1. Local transaction
        saveOrder(orderId);

        // 2. Publish event
        kafkaTemplate.send("order-events",
                new OrderCreatedEvent(orderId, amount));
    }

    private void saveOrder(String orderId) {
        // DB save
    }
}
```

---

## 7.3 Payment Service â€“ Consume Event

```java
@KafkaListener(topics = "order-events", groupId = "payment-group")
public void handleOrderCreated(OrderCreatedEvent event) {

    try {
        chargePayment(event.getOrderId(), event.getAmount());

        kafkaTemplate.send("payment-events",
                new PaymentCompletedEvent(event.getOrderId()));

    } catch (Exception ex) {

        kafkaTemplate.send("payment-events",
                new PaymentFailedEvent(event.getOrderId()));
    }
}
```

---

## 7.4 Inventory Service â€“ Consume PaymentCompleted

```java
@KafkaListener(topics = "payment-events", groupId = "inventory-group")
public void handlePayment(PaymentCompletedEvent event) {

    try {
        reserveInventory(event.getOrderId());

        kafkaTemplate.send("inventory-events",
                new InventoryReservedEvent(event.getOrderId()));

    } catch (Exception e) {

        kafkaTemplate.send("inventory-events",
                new InventoryFailedEvent(event.getOrderId()));
    }
}
```

---

## 7.5 Compensation Example (Refund)

```java
@KafkaListener(topics = "inventory-events", groupId = "payment-group")
public void handleInventoryFailure(InventoryFailedEvent event) {
    refundPayment(event.getOrderId());
}
```

---

# 8ï¸âƒ£ Orchestration Saga (Message-based)

---

## Flow

```
SagaOrchestrator
   â†“ Command
PaymentService â†’ InventoryService â†’ ShippingService
```

---

## Orchestrator Code (Simplified)

```java
@Service
public class OrderSagaOrchestrator {

    public void startSaga(Order order) {
        sendChargePayment(order);
    }

    public void onPaymentSuccess() {
        sendReserveInventory();
    }

    public void onInventoryFailure() {
        sendRefundPayment();
    }
}
```

---

## Why Orchestration is less preferred

âŒ Central bottleneck
âŒ Harder to extend
âŒ Tighter coupling

---

# 9ï¸âƒ£ Important Production Concerns

---

## 9.1 Idempotency

```java
if (eventAlreadyProcessed(eventId)) {
    return;
}
```

---

## 9.2 Exactly-once? âŒ

* Use **at-least-once**
* Make handlers idempotent

---

## 9.3 Eventual Consistency

| Step               | State     |
| ------------------ | --------- |
| Order created      | PENDING   |
| Payment success    | PAID      |
| Inventory reserved | CONFIRMED |
| Failure            | CANCELLED |

---

# ğŸ”Ÿ Message vs Event in Saga (Final Verdict)

| Use           | Use This          |
| ------------- | ----------------- |
| Start Saga    | Command / Message |
| Progress Saga | Events            |
| Notify Others | Events            |
| Compensations | Commands          |

ğŸ“Œ **Best practice**:

> **Hybrid model** â€” Commands internally, Events externally

---

# 1ï¸âƒ£1ï¸âƒ£ Interview-Ready Answer

> **Saga is typically implemented using event-driven choreography, where services publish domain events after local transactions. Message-based orchestration is also possible but leads to tighter coupling and reduced scalability.**

---

If you want next:
âœ” Saga with **Outbox Pattern**
âœ” Saga with **Temporal / Camunda**
âœ” Handling duplicate events
âœ” Saga state machine implementation
âœ” Saga vs 2PC comparison

Just say ğŸ‘

